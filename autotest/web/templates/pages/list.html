{% extends "base/layout.html" %}

{% block title %}Pages - {{ website.name }} - {{ project.name }} - {{ app_name }}{% endblock %}

{% block meta_description %}Manage and test pages for {{ website.name }}, including discovery, manual addition, and accessibility testing results.{% endblock %}

{% block breadcrumb %}
<nav aria-label="Breadcrumb" class="breadcrumb">
    <div class="container">
        <ol class="breadcrumb-list">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.index') }}" class="breadcrumb-link">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.list_projects') }}" class="breadcrumb-link">Projects</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('projects.view_project', project_id=project.project_id) }}" class="breadcrumb-link">{{ project.name }}</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('websites.view_website', project_id=project.project_id, website_id=website.website_id) }}" class="breadcrumb-link">{{ website.name }}</a>
            </li>
            <li class="breadcrumb-item" aria-current="page">
                <span class="breadcrumb-current">Pages</span>
            </li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page header -->
    <header class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">Pages</h1>
                <p class="page-description">
                    Manage discovered and manually added pages for <strong>{{ website.name }}</strong>.
                </p>
            </div>
            <div class="page-actions">
                <button type="button" class="btn btn-outline btn-sm" onclick="startDiscovery()" id="discovery-btn">
                    <svg class="btn-icon" aria-hidden="true" width="16" height="16">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Discover Pages
                </button>
                <a href="{{ url_for('pages.add_page', project_id=project.project_id, website_id=website.website_id) }}" class="btn btn-primary btn-sm">
                    <svg class="btn-icon" aria-hidden="true" width="16" height="16">
                        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
                        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Add Page
                </a>
            </div>
        </div>
    </header>
    
    <!-- Discovery progress (hidden by default) -->
    <div id="discovery-progress" class="discovery-progress" hidden>
        <div class="discovery-header">
            <h2 class="discovery-title">
                <svg class="discovery-icon animate-spin" aria-hidden="true" width="20" height="20">
                    <path d="M21 12A9 9 0 0112 3" stroke="currentColor" fill="none" stroke-width="2"/>
                </svg>
                Discovering Pages...
            </h2>
            <button type="button" class="btn btn-ghost btn-sm" onclick="cancelDiscovery()">
                Cancel
            </button>
        </div>
        <div class="discovery-stats">
            <div class="discovery-stat">
                <span class="discovery-stat-value" id="pages-found">0</span>
                <span class="discovery-stat-label">pages found</span>
            </div>
            <div class="discovery-stat">
                <span class="discovery-stat-value" id="time-elapsed">0s</span>
                <span class="discovery-stat-label">elapsed</span>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Statistics -->
    <section class="stats-section" aria-labelledby="stats-title">
        <h2 id="stats-title" class="section-title">Overview</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Total Pages</h3>
                    <svg class="stat-icon" aria-hidden="true" width="24" height="24">
                        <path d="M14 2H6A2 2 0 004 4V20A2 2 0 006 22H18A2 2 0 0020 20V8L14 2Z" stroke="currentColor" fill="none" stroke-width="2"/>
                        <polyline points="14,2 14,8 20,8" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-value">{{ stats.total_pages }}</div>
                <div class="stat-label">discovered</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Tested</h3>
                    <svg class="stat-icon" aria-hidden="true" width="24" height="24">
                        <path d="M22 11.08V12A10 10 0 1112 2A10 10 0 0122 11.08Z" stroke="currentColor" fill="none" stroke-width="2"/>
                        <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-value">{{ stats.tested_pages }}</div>
                <div class="stat-label">{{ stats.tested_pages | pluralize('page', 'pages') }}</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Issues Found</h3>
                    <svg class="stat-icon" aria-hidden="true" width="24" height="24">
                        <path d="M10.29 3.86L1.82 18A2 2 0 003.54 21H20.46A2 2 0 0022.18 18L13.71 3.86A2 2 0 0010.29 3.86Z" stroke="currentColor" fill="none" stroke-width="2"/>
                        <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2"/>
                        <line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-value">{{ stats.total_issues }}</div>
                <div class="stat-label">across {{ stats.pages_with_issues }} {{ stats.pages_with_issues | pluralize('page', 'pages') }}</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Completion</h3>
                    <svg class="stat-icon" aria-hidden="true" width="24" height="24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                        <path d="M8 12L11 15L16 9" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-value">
                    {% if stats.total_pages > 0 %}
                        {{ (stats.tested_pages / stats.total_pages * 100) | round | int }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stat-label">tested</div>
            </div>
        </div>
    </section>
    
    <!-- Filters and search -->
    <section class="filters-section" aria-labelledby="filters-title">
        <h2 id="filters-title" class="section-title">Filter & Search</h2>
        <form method="get" class="filters-form">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="status-filter" class="filter-label">Status</label>
                    <select id="status-filter" name="status" class="filter-select">
                        <option value="" {{ 'selected' if not current_filter else '' }}>All pages</option>
                        <option value="tested" {{ 'selected' if current_filter == 'tested' else '' }}>Tested ({{ stats.tested_pages }})</option>
                        <option value="scanned" {{ 'selected' if current_filter == 'scanned' else '' }}>Scanned only ({{ stats.scanned_pages - stats.tested_pages }})</option>
                        <option value="discovered" {{ 'selected' if current_filter == 'discovered' else '' }}>Discovered only ({{ stats.total_pages - stats.scanned_pages }})</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort-filter" class="filter-label">Sort by</label>
                    <select id="sort-filter" name="sort" class="filter-select">
                        <option value="url" {{ 'selected' if current_sort == 'url' else '' }}>URL</option>
                        <option value="title" {{ 'selected' if current_sort == 'title' else '' }}>Title</option>
                        <option value="status" {{ 'selected' if current_sort == 'status' else '' }}>Status</option>
                        <option value="issues" {{ 'selected' if current_sort == 'issues' else '' }}>Issues (most first)</option>
                    </select>
                </div>
                
                <div class="filter-group search-group">
                    <label for="search-input" class="filter-label">Search</label>
                    <div class="search-input-wrapper">
                        <input 
                            type="search" 
                            id="search-input" 
                            name="q" 
                            class="search-input"
                            value="{{ search_query }}"
                            placeholder="Search pages..."
                            aria-describedby="search-help"
                        >
                        <button type="submit" class="search-button" aria-label="Search">
                            <svg aria-hidden="true" width="16" height="16">
                                <circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="2"/>
                                <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                    <div id="search-help" class="filter-help">Search by URL or page title</div>
                </div>
            </div>
            
            <div class="filters-actions">
                <button type="submit" class="btn btn-outline btn-sm">Apply Filters</button>
                <a href="{{ url_for('pages.list_pages', project_id=project.project_id, website_id=website.website_id) }}" class="btn btn-ghost btn-sm">Clear</a>
            </div>
        </form>
    </section>
    
    <!-- Pages list -->
    <section class="pages-section" aria-labelledby="pages-title">
        <div class="section-header">
            <h2 id="pages-title" class="section-title">
                {% if current_filter %}
                    Filtered Pages ({{ pages | length }})
                {% else %}
                    All Pages ({{ pages | length }})
                {% endif %}
            </h2>
            {% if pages %}
                <div class="bulk-actions">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="selectAllPages()">
                        Select All
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm" onclick="showBulkActions()" id="bulk-actions-btn" disabled>
                        Bulk Actions
                    </button>
                </div>
            {% endif %}
        </div>
        
        {% if pages %}
            <form id="bulk-form" method="post" action="{{ url_for('pages.bulk_action', project_id=project.project_id, website_id=website.website_id) }}">
                <div class="pages-table-container">
                    <table class="pages-table" role="table">
                        <thead>
                            <tr>
                                <th scope="col" class="page-select-header">
                                    <input type="checkbox" id="select-all-checkbox" class="page-checkbox" onchange="toggleAllPages(this)">
                                    <label for="select-all-checkbox" class="sr-only">Select all pages</label>
                                </th>
                                <th scope="col" class="page-title-header">Page</th>
                                <th scope="col" class="page-status-header">Status</th>
                                <th scope="col" class="page-issues-header">Issues</th>
                                <th scope="col" class="page-updated-header">Last Updated</th>
                                <th scope="col" class="page-actions-header">
                                    <span class="sr-only">Actions</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in pages %}
                                <tr class="page-row">
                                    <td class="page-select-cell">
                                        <input 
                                            type="checkbox" 
                                            id="page-{{ page.page_id }}" 
                                            name="page_ids" 
                                            value="{{ page.page_id }}" 
                                            class="page-checkbox"
                                            onchange="updateBulkActions()"
                                        >
                                        <label for="page-{{ page.page_id }}" class="sr-only">
                                            Select {{ page.title or page.url }}
                                        </label>
                                    </td>
                                    <td class="page-title-cell">
                                        <div class="page-info">
                                            <a href="{{ page.url }}" target="_blank" rel="noopener noreferrer" class="page-link">
                                                {{ page.title or (page.url | truncate(50)) }}
                                                <svg class="external-icon" aria-hidden="true" width="12" height="12">
                                                    <path d="M7 7H17V17" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    <path d="M7 17L17 7" stroke="currentColor" fill="none" stroke-width="2"/>
                                                </svg>
                                            </a>
                                            <div class="page-url">{{ page.url }}</div>
                                            {% if page.description %}
                                                <div class="page-description">{{ page.description }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="page-status-cell">
                                        {% if page.last_test_date %}
                                            <span class="status-badge status-tested">Tested</span>
                                        {% elif page.last_scan_date %}
                                            <span class="status-badge status-scanned">Scanned</span>
                                        {% else %}
                                            <span class="status-badge status-discovered">Discovered</span>
                                        {% endif %}
                                    </td>
                                    <td class="page-issues-cell">
                                        {% set issue_count = page.issues | length if page.issues else 0 %}
                                        {% if issue_count > 0 %}
                                            <span class="issue-count issue-count-has-issues">{{ issue_count }}</span>
                                        {% else %}
                                            <span class="issue-count issue-count-none">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="page-updated-cell">
                                        {% if page.last_test_date %}
                                            <time datetime="{{ page.last_test_date }}">
                                                {{ page.last_test_date | format_datetime }}
                                            </time>
                                        {% elif page.last_scan_date %}
                                            <time datetime="{{ page.last_scan_date }}">
                                                {{ page.last_scan_date | format_datetime }}
                                            </time>
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td class="page-actions-cell">
                                        <div class="page-actions">
                                            <button type="button" class="btn btn-ghost btn-xs" onclick="testPage('{{ page.page_id }}')">
                                                <svg class="btn-icon" aria-hidden="true" width="14" height="14">
                                                    <polygon points="5,3 19,12 5,21" fill="currentColor"/>
                                                </svg>
                                                Test
                                            </button>
                                            {% if page.issues and page.issues | length > 0 %}
                                                <a href="{{ url_for('pages.view_page', project_id=project.project_id, website_id=website.website_id, page_id=page.page_id) }}" class="btn btn-ghost btn-xs">
                                                    <svg class="btn-icon" aria-hidden="true" width="14" height="14">
                                                        <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" fill="none" stroke-width="2"/>
                                                        <circle cx="12" cy="12" r="3" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    </svg>
                                                    View
                                                </a>
                                            {% endif %}
                                            <button type="button" class="btn btn-ghost btn-xs text-danger" onclick="deletePage('{{ page.page_id }}')">
                                                <svg class="btn-icon" aria-hidden="true" width="14" height="14">
                                                    <path d="M3 6H5H21" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    <path d="M8 6V4A2 2 0 0110 2H14A2 2 0 0116 4V6M19 6V20A2 2 0 0117 22H7A2 2 0 015 20V6H19Z" stroke="currentColor" fill="none" stroke-width="2"/>
                                                </svg>
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <svg aria-hidden="true" width="48" height="48">
                        <path d="M14 2H6A2 2 0 004 4V20A2 2 0 006 22H18A2 2 0 0020 20V8L14 2Z" stroke="currentColor" fill="none" stroke-width="2"/>
                        <polyline points="14,2 14,8 20,8" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <h3 class="empty-title">
                    {% if search_query or current_filter %}
                        No pages match your criteria
                    {% else %}
                        No pages discovered yet
                    {% endif %}
                </h3>
                <p class="empty-description">
                    {% if search_query or current_filter %}
                        Try adjusting your search or filter criteria to see more results.
                    {% else %}
                        Start by discovering pages automatically or add pages manually to begin testing.
                    {% endif %}
                </p>
                <div class="empty-actions">
                    {% if search_query or current_filter %}
                        <a href="{{ url_for('pages.list_pages', project_id=project.project_id, website_id=website.website_id) }}" class="btn btn-outline">
                            Clear Filters
                        </a>
                    {% else %}
                        <button type="button" class="btn btn-primary" onclick="startDiscovery()">
                            <svg class="btn-icon" aria-hidden="true" width="16" height="16">
                                <circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="2"/>
                                <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Discover Pages
                        </button>
                        <a href="{{ url_for('pages.add_page', project_id=project.project_id, website_id=website.website_id) }}" class="btn btn-outline">
                            <svg class="btn-icon" aria-hidden="true" width="16" height="16">
                                <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/>
                                <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Add Page Manually
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </section>
</div>

<!-- Bulk actions modal -->
<div id="bulk-modal" class="modal" hidden aria-labelledby="bulk-modal-title">
    <div class="modal-backdrop"></div>
    <div class="modal-container" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h2 id="bulk-modal-title" class="modal-title">Bulk Actions</h2>
            <button type="button" class="modal-close" onclick="hideBulkModal()" aria-label="Close dialog">
                <svg aria-hidden="true" width="24" height="24">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p class="bulk-description">
                Select an action to perform on <span id="selected-count">0</span> selected pages:
            </p>
            <div class="bulk-actions-list">
                <button type="button" class="bulk-action-btn" onclick="performBulkAction('test')">
                    <svg class="bulk-action-icon" aria-hidden="true" width="20" height="20">
                        <polygon points="5,3 19,12 5,21" fill="currentColor"/>
                    </svg>
                    <div class="bulk-action-content">
                        <div class="bulk-action-title">Run Accessibility Tests</div>
                        <div class="bulk-action-desc">Test all selected pages for accessibility issues</div>
                    </div>
                </button>
                <button type="button" class="bulk-action-btn bulk-action-danger" onclick="performBulkAction('delete')">
                    <svg class="bulk-action-icon" aria-hidden="true" width="20" height="20">
                        <path d="M3 6H5H21" stroke="currentColor" fill="none" stroke-width="2"/>
                        <path d="M8 6V4A2 2 0 0110 2H14A2 2 0 0116 4V6M19 6V20A2 2 0 0117 22H7A2 2 0 015 20V6H19Z" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                    <div class="bulk-action-content">
                        <div class="bulk-action-title">Delete Pages</div>
                        <div class="bulk-action-desc">Permanently remove selected pages</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Page header */
.page-header-content {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--spacing-lg);
}

@media (max-width: 767px) {
    .page-header-content {
        flex-direction: column;
        align-items: stretch;
    }
}

.page-actions {
    display: flex;
    gap: var(--spacing-sm);
    flex-shrink: 0;
}

@media (max-width: 767px) {
    .page-actions .btn {
        flex: 1;
    }
}

/* Discovery progress */
.discovery-progress {
    background-color: #e3f2fd;
    border: 1px solid #90caf9;
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
}

.discovery-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
}

.discovery-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
    margin: 0;
}

.discovery-stats {
    display: flex;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
}

.discovery-stat {
    text-align: center;
}

.discovery-stat-value {
    display: block;
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
}

.discovery-stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #bbdefb;
    border-radius: var(--border-radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--color-primary);
    transition: width 0.3s ease;
}

/* Statistics - reuse from previous templates */
.stats-section {
    margin-bottom: var(--spacing-2xl);
}

.section-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
    margin-top: 0;
}

.stats-grid {
    display: grid;
    gap: var(--spacing-lg);
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.stat-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    text-align: center;
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.stat-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-icon {
    color: var(--color-primary);
}

.stat-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

/* Filters */
.filters-section {
    margin-bottom: var(--spacing-2xl);
}

.filters-form {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
}

.filters-row {
    display: grid;
    gap: var(--spacing-lg);
    grid-template-columns: 1fr 1fr 2fr;
    margin-bottom: var(--spacing-lg);
}

@media (max-width: 1023px) {
    .filters-row {
        grid-template-columns: 1fr;
    }
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
}

.filter-select,
.search-input {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-base);
    color: var(--color-text-primary);
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-medium);
    border-radius: var(--border-radius-md);
    transition: border-color var(--transition-fast);
}

.filter-select:focus,
.search-input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.search-input-wrapper {
    position: relative;
}

.search-input {
    width: 100%;
    padding-right: var(--spacing-3xl);
}

.search-button {
    position: absolute;
    right: var(--spacing-xs);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-sm);
}

.search-button:hover,
.search-button:focus {
    color: var(--color-primary);
}

.filter-help {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--spacing-xs);
}

.filters-actions {
    display: flex;
    gap: var(--spacing-sm);
}

/* Section headers */
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-lg);
}

@media (max-width: 767px) {
    .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-md);
    }
}

.bulk-actions {
    display: flex;
    gap: var(--spacing-sm);
}

/* Pages table */
.pages-section {
    margin-bottom: var(--spacing-2xl);
}

.pages-table-container {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    overflow-x: auto;
}

.pages-table {
    width: 100%;
    border-collapse: collapse;
}

.pages-table th,
.pages-table td {
    padding: var(--spacing-md);
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid var(--color-border-light);
}

.pages-table th {
    background-color: var(--color-bg-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 1;
}

.pages-table tr:last-child td {
    border-bottom: none;
}

.page-select-header {
    width: 40px;
}

.page-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--color-primary);
}

.page-info {
    min-width: 300px;
}

.page-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--spacing-xs);
}

.page-link:hover,
.page-link:focus {
    color: var(--color-primary);
    text-decoration: underline;
}

.page-url {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-family: var(--font-family-mono);
    word-break: break-all;
    margin-bottom: var(--spacing-xs);
}

.page-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
}

.external-icon {
    flex-shrink: 0;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--border-radius-full);
    white-space: nowrap;
}

.status-tested {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-scanned {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.status-discovered {
    background-color: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.issue-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    border-radius: var(--border-radius-full);
}

.issue-count-has-issues {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.issue-count-none {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border-light);
}

.page-actions {
    display: flex;
    gap: var(--spacing-xs);
    justify-content: flex-end;
}

.text-muted {
    color: var(--color-text-muted);
}

.text-danger {
    color: var(--color-danger);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: var(--spacing-3xl) var(--spacing-lg);
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
}

.empty-icon {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
}

.empty-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-sm);
    margin-top: 0;
}

.empty-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--spacing-lg);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.empty-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
}

@media (max-width: 767px) {
    .empty-actions {
        flex-direction: column;
        align-items: center;
    }
}

/* Bulk actions modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-lg);
}

.modal[hidden] {
    display: none;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-container {
    position: relative;
    background-color: var(--color-bg-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--color-border-light);
}

.modal-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-sm);
}

.modal-close:hover,
.modal-close:focus {
    color: var(--color-text-primary);
}

.modal-body {
    padding: var(--spacing-lg);
}

.bulk-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-lg);
}

.bulk-actions-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.bulk-action-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    width: 100%;
    padding: var(--spacing-md);
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: left;
}

.bulk-action-btn:hover,
.bulk-action-btn:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
}

.bulk-action-danger:hover,
.bulk-action-danger:focus {
    border-color: var(--color-danger);
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
}

.bulk-action-icon {
    flex-shrink: 0;
    color: var(--color-primary);
}

.bulk-action-danger .bulk-action-icon {
    color: var(--color-danger);
}

.bulk-action-content {
    flex: 1;
}

.bulk-action-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
}

.bulk-action-desc {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

/* Animations */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let discoveryInterval = null;

// Page discovery functions
function startDiscovery() {
    const button = document.getElementById('discovery-btn');
    const originalText = button.innerHTML;
    
    // Update button state
    button.disabled = true;
    button.innerHTML = `
        <svg class="btn-icon animate-spin" aria-hidden="true" width="16" height="16">
            <path d="M21 12A9 9 0 0112 3" stroke="currentColor" fill="none" stroke-width="2"/>
        </svg>
        Starting...
    `;
    
    // Start discovery
    fetch(`{{ url_for('pages.discover_pages', project_id=project.project_id, website_id=website.website_id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show progress section
            document.getElementById('discovery-progress').hidden = false;
            
            // Start polling for status
            discoveryInterval = setInterval(checkDiscoveryStatus, 1000);
        } else {
            button.disabled = false;
            button.innerHTML = originalText;
            console.error('Discovery failed:', data.error);
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        console.error('Discovery error:', error);
    });
}

function checkDiscoveryStatus() {
    fetch(`{{ url_for('pages.discovery_status', project_id=project.project_id, website_id=website.website_id) }}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'not_running') {
            stopDiscoveryPolling();
            return;
        }
        
        // Update progress
        document.getElementById('pages-found').textContent = data.pages_found || 0;
        document.getElementById('time-elapsed').textContent = `${data.elapsed_time || 0}s`;
        document.getElementById('progress-fill').style.width = `${data.progress || 0}%`;
        
        if (data.status === 'completed' || data.status === 'error') {
            stopDiscoveryPolling();
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Status check error:', error);
    });
}

function stopDiscoveryPolling() {
    if (discoveryInterval) {
        clearInterval(discoveryInterval);
        discoveryInterval = null;
    }
    
    // Hide progress and reset button
    document.getElementById('discovery-progress').hidden = true;
    const button = document.getElementById('discovery-btn');
    button.disabled = false;
    button.innerHTML = `
        <svg class="btn-icon" aria-hidden="true" width="16" height="16">
            <circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="2"/>
            <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2"/>
        </svg>
        Discover Pages
    `;
}

function cancelDiscovery() {
    fetch(`{{ url_for('pages.cancel_discovery', project_id=project.project_id, website_id=website.website_id) }}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            stopDiscoveryPolling();
        }
    });
}

// Page testing
function testPage(pageId) {
    fetch(`{{ url_for('pages.test_page', project_id=project.project_id, website_id=website.website_id, page_id='PAGE_ID') }}`.replace('PAGE_ID', pageId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            console.log('Page test started');
        }
    });
}

function deletePage(pageId) {
    if (confirm('Are you sure you want to delete this page?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{{ url_for('pages.delete_page', project_id=project.project_id, website_id=website.website_id, page_id='PAGE_ID') }}`.replace('PAGE_ID', pageId);
        document.body.appendChild(form);
        form.submit();
    }
}

// Bulk actions
function toggleAllPages(checkbox) {
    const pageCheckboxes = document.querySelectorAll('input[name="page_ids"]');
    pageCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActions();
}

function selectAllPages() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    selectAllCheckbox.checked = true;
    toggleAllPages(selectAllCheckbox);
}

function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('input[name="page_ids"]:checked');
    const bulkButton = document.getElementById('bulk-actions-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const totalCheckboxes = document.querySelectorAll('input[name="page_ids"]');
    
    bulkButton.disabled = checkedBoxes.length === 0;
    bulkButton.textContent = checkedBoxes.length > 0 ? 
        `Bulk Actions (${checkedBoxes.length})` : 'Bulk Actions';
    
    // Update select all checkbox state
    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === totalCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function showBulkActions() {
    const checkedBoxes = document.querySelectorAll('input[name="page_ids"]:checked');
    if (checkedBoxes.length === 0) return;
    
    document.getElementById('selected-count').textContent = checkedBoxes.length;
    document.getElementById('bulk-modal').hidden = false;
}

function hideBulkModal() {
    document.getElementById('bulk-modal').hidden = true;
}

function performBulkAction(action) {
    const checkedBoxes = document.querySelectorAll('input[name="page_ids"]:checked');
    if (checkedBoxes.length === 0) return;
    
    if (action === 'delete') {
        if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} pages? This action cannot be undone.`)) {
            return;
        }
    }
    
    // Set the action and submit the form
    const form = document.getElementById('bulk-form');
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    form.appendChild(actionInput);
    
    hideBulkModal();
    form.submit();
}

// Close modal on backdrop click
document.getElementById('bulk-modal').addEventListener('click', function(e) {
    if (e.target === this || e.target.classList.contains('modal-backdrop')) {
        hideBulkModal();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateBulkActions();
});
</script>
{% endblock %}