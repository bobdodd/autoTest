{% extends "base/layout.html" %}

{% block title %}Historical Results - {{ app_name }}{% endblock %}

{% block meta_description %}Compare accessibility test results over time to track improvement progress and identify trends.{% endblock %}

{% block breadcrumb %}
<nav aria-label="Breadcrumb" class="breadcrumb">
    <div class="container">
        <ol class="breadcrumb-list">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.index') }}" class="breadcrumb-link">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('testing.dashboard') }}" class="breadcrumb-link">Testing</a>
            </li>
            {% if context.project %}
                <li class="breadcrumb-item">
                    <a href="{{ url_for('testing.project_results', project_id=context.project.project_id) }}" class="breadcrumb-link">
                        {{ context.project.name }}
                    </a>
                </li>
            {% endif %}
            <li class="breadcrumb-item" aria-current="page">
                <span class="breadcrumb-current">Historical Results</span>
            </li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Historical header -->
    <header class="historical-header">
        <div class="historical-title-section">
            <h1 class="historical-title">Historical Results</h1>
            <p class="historical-description">
                Track accessibility improvements over time
                {% if context.project %}
                    for <strong>{{ context.project.name }}</strong>
                {% endif %}.
                Compare test results and identify trends to measure your progress.
            </p>
        </div>
        <div class="historical-actions">
            <div class="time-range-selector">
                <label for="time-range" class="time-range-label">Time Range:</label>
                <select id="time-range" class="time-range-select" onchange="updateTimeRange()">
                    <option value="7d">Last 7 days</option>
                    <option value="30d" selected>Last 30 days</option>
                    <option value="90d">Last 3 months</option>
                    <option value="1y">Last year</option>
                    <option value="all">All time</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary btn-sm" onclick="refreshData()">
                <svg class="btn-icon" aria-hidden="true" width="16" height="16">
                    <path d="M23 4V10H17" stroke="currentColor" fill="none" stroke-width="2"/>
                    <path d="M20.49 15A9 9 0 1118 4L20 6" stroke="currentColor" fill="none" stroke-width="2"/>
                </svg>
                Refresh Data
            </button>
        </div>
    </header>

    <!-- Progress overview -->
    <section class="progress-overview" aria-labelledby="progress-title">
        <h2 id="progress-title" class="section-title">Progress Overview</h2>
        
        <div class="progress-cards">
            <div class="progress-card improvement">
                <div class="progress-icon">
                    <svg aria-hidden="true" width="32" height="32">
                        <path d="M7 14L12 9L17 14M12 9V21" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="progress-content">
                    <h3 class="progress-metric">{{ progress_data.violations_fixed or 23 }}</h3>
                    <p class="progress-label">Issues Fixed</p>
                    <div class="progress-change positive">
                        <svg class="change-icon" aria-hidden="true" width="16" height="16">
                            <path d="M7 14L12 9L17 14" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        <span class="change-text">{{ progress_data.improvement_rate or "+18%" }} improvement</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-card neutral">
                <div class="progress-icon">
                    <svg aria-hidden="true" width="32" height="32">
                        <circle cx="16" cy="16" r="10" stroke="currentColor" fill="none" stroke-width="2"/>
                        <polyline points="10,16 16,22 22,16" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="progress-content">
                    <h3 class="progress-metric">{{ progress_data.new_violations or 7 }}</h3>
                    <p class="progress-label">New Issues</p>
                    <div class="progress-change neutral">
                        <svg class="change-icon" aria-hidden="true" width="16" height="16">
                            <circle cx="8" cy="8" r="2" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        <span class="change-text">{{ progress_data.new_issues_rate or "+7" }} from new content</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-card status">
                <div class="progress-icon">
                    <svg aria-hidden="true" width="32" height="32">
                        <path d="M22 11.08V12A10 10 0 1112 2A10 10 0 0122 11.08Z" stroke="currentColor" fill="none" stroke-width="2"/>
                        <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" fill="none" stroke-width="2"/>
                    </svg>
                </div>
                <div class="progress-content">
                    <h3 class="progress-metric">{{ progress_data.current_score or "8.4" }}/10</h3>
                    <p class="progress-label">Accessibility Score</p>
                    <div class="progress-change positive">
                        <svg class="change-icon" aria-hidden="true" width="16" height="16">
                            <path d="M7 14L12 9L17 14" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        <span class="change-text">{{ progress_data.score_change or "+1.2" }} this month</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Trend charts -->
    <section class="charts-section" aria-labelledby="charts-title">
        <h2 id="charts-title" class="section-title">Trends Analysis</h2>
        
        <div class="charts-grid">
            <!-- Violations over time chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Issues Over Time</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="legend-color critical"></span>
                            <span class="legend-label">Critical</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color serious"></span>
                            <span class="legend-label">Serious</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color moderate"></span>
                            <span class="legend-label">Moderate</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color minor"></span>
                            <span class="legend-label">Minor</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container" id="violations-chart">
                    <!-- Chart will be rendered here -->
                    <div class="chart-placeholder">
                        <svg class="placeholder-icon" width="120" height="80" viewBox="0 0 120 80">
                            <path d="M10 70 L30 50 L50 60 L70 30 L90 40 L110 20" stroke="#3b82f6" stroke-width="3" fill="none"/>
                            <path d="M10 75 L30 65 L50 70 L70 45 L90 55 L110 35" stroke="#ef4444" stroke-width="3" fill="none"/>
                            <path d="M10 78 L30 72 L50 75 L70 55 L90 65 L110 50" stroke="#f59e0b" stroke-width="3" fill="none"/>
                            <path d="M10 80 L30 78 L50 80 L70 70 L90 75 L110 65" stroke="#10b981" stroke-width="3" fill="none"/>
                        </svg>
                        <p class="placeholder-text">Violations trend over time</p>
                    </div>
                </div>
            </div>

            <!-- Testing activity chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Testing Activity</h3>
                    <div class="chart-info">
                        <span class="chart-info-text">Pages tested per week</span>
                    </div>
                </div>
                <div class="chart-container" id="activity-chart">
                    <div class="chart-placeholder">
                        <svg class="placeholder-icon" width="120" height="80" viewBox="0 0 120 80">
                            <rect x="10" y="40" width="12" height="40" fill="#3b82f6"/>
                            <rect x="30" y="30" width="12" height="50" fill="#3b82f6"/>
                            <rect x="50" y="50" width="12" height="30" fill="#3b82f6"/>
                            <rect x="70" y="20" width="12" height="60" fill="#3b82f6"/>
                            <rect x="90" y="35" width="12" height="45" fill="#3b82f6"/>
                            <rect x="110" y="25" width="12" height="55" fill="#3b82f6"/>
                        </svg>
                        <p class="placeholder-text">Testing frequency and coverage</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Historical snapshots -->
    <section class="snapshots-section" aria-labelledby="snapshots-title">
        <h2 id="snapshots-title" class="section-title">Historical Snapshots</h2>
        
        <div class="snapshots-timeline">
            {% for snapshot in historical_snapshots %}
                <div class="snapshot-item" data-date="{{ snapshot.date }}">
                    <div class="snapshot-date">
                        <div class="date-marker"></div>
                        <time datetime="{{ snapshot.date }}" class="date-text">
                            {{ snapshot.date | format_date }}
                        </time>
                    </div>
                    <div class="snapshot-content">
                        <div class="snapshot-header">
                            <h3 class="snapshot-title">{{ snapshot.title }}</h3>
                            <div class="snapshot-stats">
                                <span class="snapshot-stat total">
                                    {{ snapshot.total_violations }} total issues
                                </span>
                                {% if snapshot.change %}
                                    <span class="snapshot-stat change {{ 'positive' if snapshot.change > 0 else 'negative' if snapshot.change < 0 else 'neutral' }}">
                                        {{ snapshot.change | abs }} {{ 'more' if snapshot.change > 0 else 'fewer' if snapshot.change < 0 else 'same' }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="snapshot-details">
                            <div class="severity-breakdown">
                                <div class="severity-item">
                                    <span class="severity-badge severity-critical">
                                        <span class="severity-dot"></span>
                                        Critical
                                    </span>
                                    <span class="severity-count">{{ snapshot.critical }}</span>
                                </div>
                                <div class="severity-item">
                                    <span class="severity-badge severity-serious">
                                        <span class="severity-dot"></span>
                                        Serious
                                    </span>
                                    <span class="severity-count">{{ snapshot.serious }}</span>
                                </div>
                                <div class="severity-item">
                                    <span class="severity-badge severity-moderate">
                                        <span class="severity-dot"></span>
                                        Moderate
                                    </span>
                                    <span class="severity-count">{{ snapshot.moderate }}</span>
                                </div>
                                <div class="severity-item">
                                    <span class="severity-badge severity-minor">
                                        <span class="severity-dot"></span>
                                        Minor
                                    </span>
                                    <span class="severity-count">{{ snapshot.minor }}</span>
                                </div>
                            </div>
                            
                            {% if snapshot.highlights %}
                                <div class="snapshot-highlights">
                                    <h4 class="highlights-title">Key Changes:</h4>
                                    <ul class="highlights-list">
                                        {% for highlight in snapshot.highlights %}
                                            <li class="highlight-item {{ highlight.type }}">
                                                <svg class="highlight-icon" aria-hidden="true" width="16" height="16">
                                                    {% if highlight.type == 'improvement' %}
                                                        <path d="M8 12L13 7L18 12" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    {% elif highlight.type == 'regression' %}
                                                        <path d="M8 7L13 12L18 7" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    {% else %}
                                                        <circle cx="8" cy="8" r="2" stroke="currentColor" fill="none" stroke-width="2"/>
                                                    {% endif %}
                                                </svg>
                                                {{ highlight.text }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="snapshot-actions">
                            <button type="button" class="btn btn-ghost btn-xs" onclick="compareSnapshots('{{ snapshot.id }}')">
                                <svg class="btn-icon" aria-hidden="true" width="14" height="14">
                                    <path d="M9 11H15M9 7H19M9 3H13M5 3L3 5L5 7" stroke="currentColor" fill="none" stroke-width="2"/>
                                </svg>
                                Compare
                            </button>
                            <a href="{{ url_for('testing.snapshot_details', snapshot_id=snapshot.id) }}" class="btn btn-outline btn-xs">
                                <svg class="btn-icon" aria-hidden="true" width="14" height="14">
                                    <path d="M1 7S3 2 7 2S13 7 13 7S11 12 7 12S1 7 1 7Z" stroke="currentColor" fill="none" stroke-width="2"/>
                                    <circle cx="7" cy="7" r="2" stroke="currentColor" fill="none" stroke-width="2"/>
                                </svg>
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

    <!-- Comparison analysis -->
    <section class="comparison-section" aria-labelledby="comparison-title" id="comparison-section" style="display: none;">
        <h2 id="comparison-title" class="section-title">Snapshot Comparison</h2>
        
        <div class="comparison-container">
            <div class="comparison-header">
                <div class="comparison-selector">
                    <label for="baseline-snapshot">Baseline:</label>
                    <select id="baseline-snapshot" class="comparison-select">
                        <option value="">Select baseline snapshot</option>
                        {% for snapshot in historical_snapshots %}
                            <option value="{{ snapshot.id }}">{{ snapshot.date | format_date }} - {{ snapshot.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="comparison-vs">vs</div>
                <div class="comparison-selector">
                    <label for="target-snapshot">Compare to:</label>
                    <select id="target-snapshot" class="comparison-select">
                        <option value="">Select target snapshot</option>
                        {% for snapshot in historical_snapshots %}
                            <option value="{{ snapshot.id }}">{{ snapshot.date | format_date }} - {{ snapshot.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" class="btn btn-primary btn-sm" onclick="performComparison()">
                    Compare Snapshots
                </button>
            </div>
            
            <div class="comparison-results" id="comparison-results" style="display: none;">
                <!-- Comparison results will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Recommendations -->
    <section class="recommendations-section" aria-labelledby="recommendations-title">
        <h2 id="recommendations-title" class="section-title">Recommendations</h2>
        
        <div class="recommendations-grid">
            <div class="recommendation-card priority">
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Focus on Critical Issues</h3>
                    <span class="recommendation-badge critical">High Priority</span>
                </div>
                <div class="recommendation-content">
                    <p class="recommendation-description">
                        You have {{ progress_data.critical_issues or 3 }} critical accessibility issues that should be addressed immediately. 
                        These significantly impact user experience for people with disabilities.
                    </p>
                    <div class="recommendation-action">
                        <a href="{{ url_for('testing.filtered_results', severity='critical') }}" class="btn btn-primary btn-sm">
                            View Critical Issues
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="recommendation-card improvement">
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Great Progress!</h3>
                    <span class="recommendation-badge positive">Trending Well</span>
                </div>
                <div class="recommendation-content">
                    <p class="recommendation-description">
                        You've fixed {{ progress_data.violations_fixed or 23 }} issues in the last 30 days. 
                        Keep up the momentum by focusing on moderate severity issues next.
                    </p>
                    <div class="recommendation-action">
                        <a href="{{ url_for('testing.filtered_results', severity='moderate') }}" class="btn btn-outline btn-sm">
                            View Moderate Issues
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="recommendation-card testing">
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Increase Testing Frequency</h3>
                    <span class="recommendation-badge neutral">Suggestion</span>
                </div>
                <div class="recommendation-content">
                    <p class="recommendation-description">
                        Regular testing helps catch issues early. Consider setting up automated testing 
                        or scheduling weekly manual tests for better coverage.
                    </p>
                    <div class="recommendation-action">
                        <a href="{{ url_for('testing.dashboard') }}" class="btn btn-outline btn-sm">
                            Schedule Tests
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Historical header */
.historical-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
}

@media (max-width: 767px) {
    .historical-header {
        flex-direction: column;
        align-items: stretch;
    }
}

.historical-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-sm);
    margin-top: 0;
}

.historical-description {
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin: 0;
}

.historical-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-shrink: 0;
}

.time-range-selector {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.time-range-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
}

.time-range-select {
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-md);
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

/* Section titles */
.section-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
    margin-top: 0;
}

/* Progress overview */
.progress-overview {
    margin-bottom: var(--spacing-2xl);
}

.progress-cards {
    display: grid;
    gap: var(--spacing-lg);
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.progress-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    transition: box-shadow var(--transition-fast);
}

.progress-card:hover {
    box-shadow: var(--shadow-md);
}

.progress-card.improvement {
    border-left: 4px solid var(--color-success);
}

.progress-card.neutral {
    border-left: 4px solid var(--color-warning);
}

.progress-card.status {
    border-left: 4px solid var(--color-primary);
}

.progress-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-bg-secondary);
    border-radius: var(--border-radius-lg);
}

.progress-card.improvement .progress-icon {
    color: var(--color-success);
    background-color: #f0fdf4;
}

.progress-card.neutral .progress-icon {
    color: var(--color-warning);
    background-color: #fffbeb;
}

.progress-card.status .progress-icon {
    color: var(--color-primary);
    background-color: #eff6ff;
}

.progress-content {
    flex: 1;
}

.progress-metric {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
    margin-top: 0;
}

.progress-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-sm);
}

.progress-change {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
}

.progress-change.positive {
    color: var(--color-success);
}

.progress-change.negative {
    color: var(--color-danger);
}

.progress-change.neutral {
    color: var(--color-text-muted);
}

.change-icon {
    flex-shrink: 0;
}

/* Charts section */
.charts-section {
    margin-bottom: var(--spacing-2xl);
}

.charts-grid {
    display: grid;
    gap: var(--spacing-lg);
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
}

.chart-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
}

.chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-lg);
}

.chart-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
}

.chart-legend {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: var(--border-radius-sm);
}

.legend-color.critical {
    background-color: #ef4444;
}

.legend-color.serious {
    background-color: #f59e0b;
}

.legend-color.moderate {
    background-color: #3b82f6;
}

.legend-color.minor {
    background-color: #10b981;
}

.legend-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.chart-info {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.chart-container {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-placeholder {
    text-align: center;
    color: var(--color-text-muted);
}

.placeholder-icon {
    opacity: 0.6;
    margin-bottom: var(--spacing-sm);
}

.placeholder-text {
    font-size: var(--font-size-sm);
    margin: 0;
}

/* Historical snapshots */
.snapshots-section {
    margin-bottom: var(--spacing-2xl);
}

.snapshots-timeline {
    position: relative;
}

.snapshots-timeline::before {
    content: '';
    position: absolute;
    left: 24px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: var(--color-border-light);
}

.snapshot-item {
    display: flex;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
    position: relative;
}

.snapshot-date {
    flex-shrink: 0;
    width: 120px;
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
}

.date-marker {
    width: 12px;
    height: 12px;
    border: 3px solid var(--color-primary);
    background-color: var(--color-bg-primary);
    border-radius: 50%;
    margin-top: 4px;
    position: relative;
    z-index: 1;
}

.date-text {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    line-height: var(--line-height-tight);
}

.snapshot-content {
    flex: 1;
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
}

.snapshot-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.snapshot-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
}

.snapshot-stats {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
}

.snapshot-stat {
    font-size: var(--font-size-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius-sm);
}

.snapshot-stat.total {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-primary);
}

.snapshot-stat.change.positive {
    background-color: #fef2f2;
    color: #991b1b;
}

.snapshot-stat.change.negative {
    background-color: #f0fdf4;
    color: #166534;
}

.snapshot-stat.change.neutral {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-muted);
}

.snapshot-details {
    margin-bottom: var(--spacing-lg);
}

.severity-breakdown {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.severity-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.severity-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
}

.severity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.severity-badge.severity-critical .severity-dot {
    background-color: #ef4444;
}

.severity-badge.severity-serious .severity-dot {
    background-color: #f59e0b;
}

.severity-badge.severity-moderate .severity-dot {
    background-color: #3b82f6;
}

.severity-badge.severity-minor .severity-dot {
    background-color: #10b981;
}

.severity-count {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.snapshot-highlights {
    margin-top: var(--spacing-md);
}

.highlights-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-sm);
    margin-top: 0;
}

.highlights-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.highlight-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-relaxed);
}

.highlight-item.improvement {
    color: var(--color-success);
}

.highlight-item.regression {
    color: var(--color-danger);
}

.highlight-item.neutral {
    color: var(--color-text-muted);
}

.highlight-icon {
    flex-shrink: 0;
}

.snapshot-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
}

/* Comparison section */
.comparison-section {
    margin-bottom: var(--spacing-2xl);
}

.comparison-container {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
}

.comparison-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
}

.comparison-selector {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.comparison-selector label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
}

.comparison-select {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-md);
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    min-width: 200px;
}

.comparison-vs {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-muted);
    margin: 0 var(--spacing-sm);
    align-self: flex-end;
    margin-bottom: var(--spacing-sm);
}

/* Recommendations */
.recommendations-section {
    margin-bottom: var(--spacing-2xl);
}

.recommendations-grid {
    display: grid;
    gap: var(--spacing-lg);
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
}

.recommendation-card {
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
}

.recommendation-card.priority {
    border-left: 4px solid var(--color-danger);
}

.recommendation-card.improvement {
    border-left: 4px solid var(--color-success);
}

.recommendation-card.testing {
    border-left: 4px solid var(--color-primary);
}

.recommendation-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.recommendation-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
}

.recommendation-badge {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius-full);
}

.recommendation-badge.critical {
    background-color: #fee2e2;
    color: #991b1b;
}

.recommendation-badge.positive {
    background-color: #d1fae5;
    color: #065f46;
}

.recommendation-badge.neutral {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-muted);
}

.recommendation-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--spacing-md);
}

.recommendation-action {
    display: flex;
    justify-content: flex-start;
}

/* Responsive design */
@media (max-width: 767px) {
    .historical-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .time-range-selector {
        justify-content: space-between;
    }
    
    .snapshot-item {
        flex-direction: column;
        gap: var(--spacing-md);
    }
    
    .snapshot-date {
        width: auto;
        align-items: center;
    }
    
    .comparison-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .comparison-vs {
        align-self: center;
        margin: var(--spacing-sm) 0;
    }
    
    .severity-breakdown {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentTimeRange = '30d';
let selectedSnapshots = [];

function updateTimeRange() {
    const select = document.getElementById('time-range');
    currentTimeRange = select.value;
    
    // Filter snapshots based on time range
    filterSnapshotsByTimeRange();
    
    // Update charts and data
    refreshData();
}

function filterSnapshotsByTimeRange() {
    const snapshots = document.querySelectorAll('.snapshot-item');
    const now = new Date();
    let cutoffDate;
    
    switch (currentTimeRange) {
        case '7d':
            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case '30d':
            cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
        case '90d':
            cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            break;
        case '1y':
            cutoffDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
            break;
        case 'all':
            cutoffDate = new Date(0);
            break;
    }
    
    snapshots.forEach(snapshot => {
        const snapshotDate = new Date(snapshot.dataset.date);
        if (snapshotDate >= cutoffDate) {
            snapshot.style.display = 'flex';
        } else {
            snapshot.style.display = 'none';
        }
    });
}

function refreshData() {
    // In a real implementation, this would fetch fresh data from the server
    showToast('Data refreshed for ' + currentTimeRange);
    
    // Simulate loading charts
    setTimeout(() => {
        updateChartPlaceholders();
    }, 500);
}

function updateChartPlaceholders() {
    // Add loading animation and then update charts
    const charts = document.querySelectorAll('.chart-placeholder');
    charts.forEach(chart => {
        chart.style.opacity = '0.5';
        setTimeout(() => {
            chart.style.opacity = '1';
        }, 300);
    });
}

function compareSnapshots(snapshotId) {
    // Show comparison section
    const comparisonSection = document.getElementById('comparison-section');
    comparisonSection.style.display = 'block';
    
    // Auto-select the snapshot for comparison
    const targetSelect = document.getElementById('target-snapshot');
    targetSelect.value = snapshotId;
    
    // Scroll to comparison section
    comparisonSection.scrollIntoView({ behavior: 'smooth' });
    
    showToast('Snapshot selected for comparison');
}

function performComparison() {
    const baselineId = document.getElementById('baseline-snapshot').value;
    const targetId = document.getElementById('target-snapshot').value;
    
    if (!baselineId || !targetId) {
        showToast('Please select both snapshots to compare', 'error');
        return;
    }
    
    if (baselineId === targetId) {
        showToast('Please select different snapshots to compare', 'error');
        return;
    }
    
    // Show loading state
    const resultsContainer = document.getElementById('comparison-results');
    resultsContainer.style.display = 'block';
    resultsContainer.innerHTML = `
        <div class="comparison-loading">
            <div class="loading-spinner"></div>
            <p>Comparing snapshots...</p>
        </div>
    `;
    
    // Simulate comparison analysis
    setTimeout(() => {
        showComparisonResults(baselineId, targetId);
    }, 1500);
}

function showComparisonResults(baselineId, targetId) {
    const resultsContainer = document.getElementById('comparison-results');
    
    // Mock comparison results
    const comparisonHTML = `
        <div class="comparison-result">
            <div class="comparison-summary">
                <h3>Comparison Summary</h3>
                <div class="summary-stats">
                    <div class="summary-stat improvement">
                        <span class="stat-value">-12</span>
                        <span class="stat-label">Issues Fixed</span>
                    </div>
                    <div class="summary-stat regression">
                        <span class="stat-value">+3</span>
                        <span class="stat-label">New Issues</span>
                    </div>
                    <div class="summary-stat neutral">
                        <span class="stat-value">9</span>
                        <span class="stat-label">Net Improvement</span>
                    </div>
                </div>
            </div>
            
            <div class="comparison-breakdown">
                <h4>Severity Breakdown</h4>
                <div class="breakdown-grid">
                    <div class="breakdown-item">
                        <span class="breakdown-label critical">Critical</span>
                        <span class="breakdown-change">2 → 0 (-2)</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label serious">Serious</span>
                        <span class="breakdown-change">8 → 5 (-3)</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label moderate">Moderate</span>
                        <span class="breakdown-change">12 → 9 (-3)</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label minor">Minor</span>
                        <span class="breakdown-change">15 → 18 (+3)</span>
                    </div>
                </div>
            </div>
            
            <div class="comparison-insights">
                <h4>Key Insights</h4>
                <ul class="insights-list">
                    <li class="insight-item positive">
                        <svg class="insight-icon" width="16" height="16">
                            <path d="M8 12L13 7L18 12" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        All critical accessibility issues have been resolved
                    </li>
                    <li class="insight-item positive">
                        <svg class="insight-icon" width="16" height="16">
                            <path d="M8 12L13 7L18 12" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        Significant improvement in color contrast compliance
                    </li>
                    <li class="insight-item neutral">
                        <svg class="insight-icon" width="16" height="16">
                            <circle cx="8" cy="8" r="2" stroke="currentColor" fill="none" stroke-width="2"/>
                        </svg>
                        Minor issues increased due to new content additions
                    </li>
                </ul>
            </div>
        </div>
    `;
    
    resultsContainer.innerHTML = comparisonHTML;
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: ${type === 'error' ? 'var(--color-danger)' : 'var(--color-success)'};
        color: white;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius-md);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        z-index: 1000;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    }, 10);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set initial time range
    updateTimeRange();
    
    // Add loading spinner styles
    const style = document.createElement('style');
    style.textContent = `
        .comparison-loading {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--color-text-muted);
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-bg-secondary);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .comparison-result {
            padding: var(--spacing-lg);
            background-color: var(--color-bg-secondary);
            border-radius: var(--border-radius-md);
        }
        
        .comparison-summary {
            margin-bottom: var(--spacing-lg);
        }
        
        .summary-stats {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-xs);
        }
        
        .summary-stat.improvement .stat-value {
            color: var(--color-success);
        }
        
        .summary-stat.regression .stat-value {
            color: var(--color-danger);
        }
        
        .summary-stat.neutral .stat-value {
            color: var(--color-text-primary);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }
        
        .breakdown-grid {
            display: grid;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background-color: var(--color-bg-primary);
            border-radius: var(--border-radius-sm);
        }
        
        .breakdown-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        .breakdown-change {
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }
        
        .insights-list {
            list-style: none;
            padding: 0;
            margin: var(--spacing-md) 0 0;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
            font-size: var(--font-size-sm);
        }
        
        .insight-item.positive {
            color: var(--color-success);
        }
        
        .insight-item.neutral {
            color: var(--color-text-muted);
        }
        
        .insight-icon {
            flex-shrink: 0;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}